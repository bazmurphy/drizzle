# Drizzle ORM

## Investigation Spike

https://orm.drizzle.team/

---

- `npm init -y`

- `npm install drizzle-orm pg dotenv`

- `npm install -D drizzle-kit @types/pg ts-node`

---

- create `.env` in the root

```sh
# .env

DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_DATABASE=drizzle_test
```

---

- create `drizzle.config.ts` in the root

```ts
// drizzle.config.ts

import type { Config } from "drizzle-kit";

export default {
  // the location of the schema file
  schema: "./src/database/schema.ts",
  // the directory to output the migrations to
  out: "./migrations",
} satisfies Config;
```

- create `src/` folder in the root
- create `database/` folder inside `src/`

- create `index.ts` inside `database/`

```ts
// src/database/index.ts

import "dotenv/config";
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  // connectionString: "postgres://user:password@host:port/db"
  host: process.env.DB_HOST,
  port: Number(process.env.DB_PORT),
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE,
});

export const db = drizzle(pool);
```

- create `schema.ts` inside `database/`

```ts
// src/database/schema.ts

import { pgTable, serial, text, varchar } from "drizzle-orm/pg-core";

// This is how we define a Table
export const users = pgTable("users", {
  // this is how we define Columns
  id: serial("id").primaryKey(),
  fullName: text("full_name"),
  phone: varchar("phone", { length: 30 }),
});
```

- create `migrate.ts` inside `database/`

```ts
// src/database/migrate.ts

import { migrate } from "drizzle-orm/node-postgres/migrator";
import { db } from "./index";

async function main() {
  try {
    console.log("Migration Started...");

    // we call the migrate function from drizzle and have to pass in:
    // [1] the database connection
    // [2] an object with the migrations folder path
    await migrate(db, { migrationsFolder: "migrations" });

    console.log("Migration Ended...");
    process.exit(0);
  } catch (error) {
    console.error(error);
    process.exit(1);
  }
}

main();
```

- add 3 scripts to `package.json` for generating the migration, for applying the migration, and the two combined

- now we can use `npm run migration`

```json
// package.json
"scripts": {
  "database:migration:generate": "drizzle-kit generate:pg",
  "database:migration:apply": "ts-node src/database/migrate.ts",
  "database:migration": "drizzle-kit generate:pg && ts-node src/database/migrate.ts",
},
```

- a folder called `migrations/` is autogenerated in the root which contains a `.sql` migration file

---

- the main Type Categories in PostgreSQL

- Numeric
  - `integer` (-2 billion to +2 billion)
  - `smallint` (-32,768 to +32,767)
  - `bigint` (-9 quintillion to +9 quintillion)
  - `serial` (auto incrementing)
    - `serial` (serial4) (integer type)
    - `smallserial` (serial2) (smallint type)
    - `bigserial` (serial8) (bigint type)
  - `decimal`
    - `decimal` (131072 digits before the decimal point, 16383 digits after the decimal point)
    - `real` (float4) (6 digit decimal precision)
    - `double` doublePrecision (float8) (15 digit decimal precision)
- `boolean` ( 0 / 1 or true / false)
- Text
  - `text` (variable length unlimited character string)
  - `varchar` (variable length character string, can store strings up to N characters (not bytes))
  - `char` (fixed-length, blank padded character string, can store strings up to N characters (not bytes))
- JSON ()
  - `json` (you can store a javascript object saved as a json string)
  - `jsonb` (the json will converted to binary form of the object)
- DateTime
  - `time` (only the time)
  - `timestamp` (the time and the date)
  - `date` (only the date)
  - `interval` (the number of milliseconds between two specific datetimes)
- `enum` (similar to TypeScript see below)
- `binary`

```ts
// we use pgEnum() and pass it the name of the enum, and the possible values of the enum
export const moodEnum = pgEnum("mood", ["sad", "ok", "happy"]);

export const typesTable = pgTable("typesTable", {
  exampleInteger: integer("exampleInteger"),

  exampleSmallInt: smallint("exampleSmallInt"),

  exampleBigInt: bigint("exampleBigInt", { mode: "number" }), // { mode: "bigint" }

  exampleSerial: serial("exampleSerial"),

  exampleSmallSerial: smallserial("exampleSmallSerial"),

  exampleBigSerial: bigserial("exampleBigSerial", { mode: "number" }), // { mode: "bigint" }

  exampleSerialWithPrimaryKey: serial(
    "exampleSerialWithPrimaryKey"
  ).primaryKey(),

  exampleDecimal: decimal("exampleDecimal", { precision: 7, scale: 2 }), // 12345.67 precision is total number of digits, scale is number of digits after the decimal point

  exampleNumeric: numeric("exampleNumeric", { precision: 7, scale: 2 }), // 12345.67 this is the same as the decimal type^

  exampleReal: real("exampleReal"),

  exampleDoublePrecision: doublePrecision("exampleDoublePrecision"),

  exampleBoolean: boolean("exampleBoolean"),

  exampleText: text("exampleText"),

  exampleVarChar: varchar("exampleVarChar", { length: 256 }), // it can store a text string up to at most 256 characters

  exampleChar: char("exampleChar", { length: 10 }), // it will add blank space to fill the remaining space up to the length

  exampleJSON: json("exampleJSON"),

  exampleJSONb: jsonb("exampleJSONb"),

  exampleTime: time("exampleTime", {
    precision: 4, // this sets the number of decimals after the second
    withTimezone: true, // it should include timezone information, the "+00" at the end of the string denotes the timezone
  }).defaultNow(), // if no value is provided the current timestamp will be used

  exampleTimeStamp: timestamp("exampleTimeStamp", {
    mode: "date", // "string" / "date" to choose to save it as either a string or a date
  }).defaultNow(),

  exampleDate: date("exampleDate"),

  exampleInterval: interval("exampleInterval"),

  exampleEnum: moodEnum("exampleEnum").default("ok"), // we can chain on .default() and specify the default value
});
```

### Default Values:

we can chain on .default() and specify the default value
for date time we can use .defaultNow()

### Not Null:

by default all your values CAN be Null, we can chain on .notNull()

### Primary Key:

set the primary key of your table, we can chain on .primaryKey()

---

## Write A Query

```ts
const query = await db.select().from(users);
```
